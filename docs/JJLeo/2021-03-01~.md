# 2021-03-01~

## **CF1491G**

### 题意

有 $n$ 个硬币，第 $i$ 个位置上的硬币为 $c_i$，保证 $c_1,c_2,\cdots,c_n$ 是一个 $1$ 到 $n$ 的排列。初始，所有硬币均朝上，你可以进行至多 $n+1$ 次下述操作：

- 将第 $i$ 个位置和第 $j$ 个位置的硬币互换，并将它们翻面。

最终需要使得第 $i$ 个位置上的硬币为 $i$，且所有硬币均朝上，构造一种方案，不必最小化操作数。($3 \le n \le 2 \times 10^5$)

### 题解

考虑建图，第 $i$ 个位置向 $c_i$ 连一条有向边，每个位置对应的点有两种颜色，红色代表该位置的点为正面，蓝色代表该位置的点为反面。最终我们想达到的目标即所有点均为自环且为红色。

对于一次操作，相当于将 $i,j$ 指向的点互换，同时将两者颜色互换后翻转。

对于两个环，我们在一个环上各选一个点进行操作，可以得到一个大环，且环上有两个蓝点，不断选择操作一个蓝点 $i$ 和该蓝点指向的点 $j$，结果为 $j$ 成为红色的自环，$i$ 仍是蓝点且指向 $j$ 所指向的点。最终剩下两个蓝点进行一次操作即可变为两个自环的红点。设这两个环大小之和为 $m$，则我们一共操作了恰好 $m$ 次。

但是，如果环的数量是奇数，就不好配对了，分两种情况讨论：

- 如果所有环的数量 $x$ 不为 $1$，那么我们可以先将 $x-1$ 个环按上述方法配对，再令最后一个环和一个单独的自环红点配对即可，这样只需多做一次操作。
- 如果恰好只有一个环，可以通过两次操作将整个环变为恰有两个蓝点的环：设按环的顺序初始三个点为 $i,j,k$，操作 $i,j$ 再操作 $j,k$，则环顺序改为 $i,k,j, \cdots$，且 $i,j$ 是蓝点，之后按上述方法来进行 $n-1$ 次即可。

综上，如果环的数量是奇数，只需 $n+1$ 次，否则只需 $n$ 次。

## **CF1491H**

### 题意

给出一颗 $n$ 个节点的树，$1$ 号点为根节点，第 $i$ ($i > 1$) 个节点的父亲为 $a_i$，保证 $a_i < i$，有 $q$ 次如下两种操作之一：

- 给定 $l,r,x$，对所有 $l \le i \le r$，将 $a_i$ 变为 $\max(a_i-x,1)$。
- 给定 $x,y$，询问 $\operatorname{lca}(x,y)$。

($2\leq n,q \leq 10^5$)

### 题解

考虑将所有节点按下标分成连续的 $\sqrt n$ 块，对于每个节点维护 $f_i$，表示所在块内深度最小的祖先，如果不存在这样的节点，则 $f_i=i$。

考虑我们这棵树的特点，有 $a_i < i$ 恒成立，从而必然不存在 $x,y,z$ 使得 $y$ 是 $x$ 的祖先，$z$ 是 $y$ 的祖先，但 $x,z$ 属于同一块，$y$ 和 $x,z$ 不属于同一块。（形象地说就是不存在一条从下到上块内点出现不连续的链）

因此对于 $f_i$ 的求解，只需从小到大枚举 $i$ 扫一遍即可，即如果 $a_i$ 和 $i$ 是同一块的，则 $f_i=f_{a_i}$，否则 $f_i=i$。

我们考虑对 $a_i$ 进行区间减时如何快速维护 $f_i$：

- 对于两端的部分，直接暴力修改 $a_i$ 并更新该块即可，时间复杂度不超过 $O(q\sqrt n)$。
- 对于中间的数个整块，先对 $a_i$ 进行区间的标记，再考虑暴力修改 $f_i$，注意暴力修改 $f_i$ 的操作每个块至多进行 $\sqrt n$ 次，因为每次至少减少 $1$，当操作次数超过 $\sqrt n$ 时该块内所有 $a_i$ 必然有 $i-a_i > \sqrt n$，从而必然有 $f_i=i$，即 $f_i$ 不会发生改变，因此记录一下修改次数，超过后就不再对 $f_i$ 进行暴力修改。那么这一部分均摊下来总复杂度不超过 $O(n\sqrt n)$。

利用 $f_i$ ，我们可以在 $O(\sqrt n)$ 的时间内求出两个节点 $x,y$ 的 $\operatorname{lca}(x,y)$：

- 如果 $f_x=f_y$，则进行下一步；否则不妨设 $x>y$，令 $x=a_{f_x}$。
- 如果 $x=y$，则该点即为所求答案；否则不妨设 $x>y$，令 $x=a_{x}$。

上述过程类似倍增求 $\operatorname{lca}$，利用上述所说 $a_i < i$ 所带来的条件，如果 $f_x\ne f_y$，那么 $\operatorname{lca}$ 必然还在上面，因此直接向上跳；如果 $f_x= f_y$，那么 $\operatorname{lca}$ 必然在当前块，同样暴力跳即可。

综上，总时间复杂度即为 $O\big((n+q)\sqrt n \big)$。

## **CF1494F**

### 题意

给定一张 $n$ 个点 $m$ 条边的无向联通图，你可以从任意点出发，删掉经过的每一条边。你可以在任意时刻开启一个 **mode shift** 模式，使得开启这个模式后经过的第一条边不删，第二条边删，第三条边不删，第四条边删 ......

开启模式后不能关闭，你可以选择不开启模式，给出一种方案使得所有边都被删完，或判断无解。($2 \le n \le 3000$，$n - 1 \le m \le \min(\dfrac{n(n-1)}{2}, 3000)$)

### 题解

如果开启 **mode shift** 后将图走完的话，开启 **mode shift** 后所删掉的图必然是一个菊花图，证明如下：

> 考虑删掉的最后一条边 $(u,v)$，不妨设最后一步为从 $u$ 走到 $v$，那么倒数第二步不能删边，而图上和 $v$ 相连的只有 $(u,v)$ 这一条边，因此必然是从 $v$ 走到 $u$。
>
> 重复上述过程，易得到开启 **mode shift** 后一直在 $u$ 和其相邻的点间一来一回，从而所删掉的图必然是一个菊花图。

因此我们只需将原图分为两部分 $G_1$ 和 $G_2$，前者存在以点 $x$ 为结尾的欧拉路径，后者是以点 $x$ 为中心的菊花图。

枚举点 $x$，想让 $G_1$ 存在欧拉路径，必然其中度数为奇数的点只能有 $0$ 或 $2$ 个，因此对于所有一个端点是 $x$ 的边，如果让其加入 $G_2$ 可以让另一端点的度数为偶，就选择加入 $G_2$，否则不选择。之后 check 一次是否满足上述条件。

如果不满足上述条件，可以证明合法情况最多翻转一条边，否则会增加两个奇数的点，分情况讨论：

- 当 $x$ 度数为奇时，翻转后有至少 $3$ 个度数为奇的点，显然不合法。
- 当 $x$ 度数为偶时，翻转后有至少 $2$ 个度数为奇的点，即使有 $2$ 个，因为 $x$ 度数为偶，不能作为欧拉路径的起点，因此不合法。

从而枚举每条边是否翻转并进行验证即可，总复杂度为 $O\big(m(n+m)\big)$。

## **ARC112E**

### 题意

现在有一个排列 $1,2,\cdots,n$，每次操作可以把一个数放到最前或放到最后，一共进行 $m$ 次操作，问有多少种操作方案使得最终排列为 $a_1,a_2,\cdots,a_n$。($2 \le n \le 3000$，$1 \le m \le 3000$)

### 题解

考虑一个操作为**关键操作**当且仅当之后没有对这个数进行过任何操作，那么假设进行了 $l$ 次向前放的**关键操作**，$r$ 次向后放的**关键操作**，那么必然有 $a_{l+1},a_{l+2},\cdots,a_{n-r}$ 单增。

对于给定的 $a_1,a_2,\cdots,a_n$，显然第 $i$ 次向前放或向后方的**关键操作**所操作的数都是确定的。那么当上述 $l,r$ 确定时，如果下面两个量可以确定，那么对应的操作序列就可以唯一确定：

- 哪些操作是向前放/向后放的**关键操作**。
- 对于其它操作，它所操作的数是后面的哪一个**关键操作**所操作的数，以及这个操作是先前放还是向后放。

从而可以设 $f_{i,j,k}$ 为考虑后 $i$ 个操作，已经进行了 $j$ 个向前放、$k$ 个向后放的**关键操作**的方案数，转移为：
$$
\begin{aligned}
f_{i,j,k} &\to f_{i+1,j+1,k} \newline
f_{i,j,k} &\to f_{i+1,j,k+1} \newline
2(j+k)f_{i,j,k} &\to f_{i+1,j,k} 
\end{aligned}
$$
注意到后两维其实可以合并，设 $f_{i,j}$ 为考虑后 $i$ 个操作，已经进行了 $j$ 个**关键操作**的方案数，最后再乘以一个组合数 $\dbinom{l+r}{l}$ 即可，转移为：
$$
\begin{aligned}
f_{i,j} &\to f_{i+1,j+1} \newline
2jf_{i,j} &\to f_{i+1,j} 
\end{aligned}
$$
最后枚举所有单增的 $a_{l+1},a_{l+2},\cdots,a_{n-r}$，累加答案 $\dbinom{l+r}{l}f_{m,l+r}$ 即可，总时间复杂度为 $O(nm+n^2)$。

